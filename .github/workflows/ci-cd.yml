name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  # Frontend: Build and Lint
  frontend-build:
    name: Frontend Build & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile
        timeout-minutes: 10

      - name: Lint code
        run: bun run lint
        timeout-minutes: 5

      - name: Build project
        run: bun run build
        timeout-minutes: 10

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        if: success()
        with:
          name: frontend-build
          path: .next
          retention-days: 5

  # Backend: Tests & Type Checking
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Create virtual environment
        run: uv venv

      - name: Install dependencies
        run: uv pip install -e .
        timeout-minutes: 10

      - name: Run pytest
        run: uv run pytest tests/ -v --tb=short --cov=. --cov-report=xml
        timeout-minutes: 10
        continue-on-error: true

      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-report
          path: api/coverage.xml
          retention-days: 5

  # Security: Python Vulnerability Scan (Bandit)
  security-python:
    name: Security Scan - Python
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml]
        timeout-minutes: 5

      - name: Run Bandit security scan
        run: bandit -r . -f json -o bandit-report.json || true
        timeout-minutes: 5

      - name: Display Bandit results
        run: |
          if [ -f bandit-report.json ]; then
            echo "=== Bandit Security Scan Results ==="
            python3 -m json.tool bandit-report.json | grep -A5 '"severity"' || echo "No high-severity issues found"
          fi

      - name: Upload Bandit report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: bandit-report
          path: api/bandit-report.json
          retention-days: 5

  # Security: JavaScript Dependency Check
  security-frontend:
    name: Security Scan - Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install --frozen-lockfile
        timeout-minutes: 10

      - name: Check for vulnerabilities
        run: bun audit || true

  # Build Status Check
  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-test, security-python]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "Frontend Build: ${{ needs.frontend-build.result }}"
          echo "Backend Tests: ${{ needs.backend-test.result }}"
          echo "Security Scan: ${{ needs.security-python.result }}"

          if [[ "${{ needs.frontend-build.result }}" == "failure" || "${{ needs.backend-test.result }}" == "failure" ]]; then
            echo "❌ Build failed"
            exit 1
          else
            echo "✅ Build successful"
          fi

  # Deploy Notification (optional)
  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-status]
    if: always()

    steps:
      - name: Success message
        if: needs.build-status.result == 'success'
        run: |
          echo "✅ All CI/CD checks passed!"
          echo "Repository is ready for deployment"

      - name: Failure message
        if: needs.build-status.result == 'failure'
        run: |
          echo "❌ CI/CD checks failed"
          echo "Please review the logs above"
          exit 1
